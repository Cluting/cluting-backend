<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <div class="col-6">
        <h1 th:text="${room.name}">Room Name</h1>
    </div>
    <div>
        <div id="msgArea" class="col"></div>
        <div class="col-6">
            <div class="input-group mb-3">
                <input type="text" id="msg" class="form-control" placeholder="Enter your message">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="button-send">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:inline="javascript">
    $(document).ready(function () {
        var roomName = /*[[${room.name}]]*/ '';
        var roomId = /*[[${room.roomId}]]*/ '';
        var username = 'eunjae';

        console.log("Room: " + roomName + ", ID: " + roomId + ", User: " + username);

        var sockJs = new SockJS("/stomp/chat");
        var stomp = Stomp.over(sockJs);

        stomp.connect({}, function () {
            console.log("STOMP Connection established");

            stomp.subscribe("/sub/chat/room/" + roomId, function (chat) {
                var content = JSON.parse(chat.body);
                var writer = content.writer;
                var message = content.message;
                var str = '';

                if (writer === username) {
                    str = "<div class='col-6'><div class='alert alert-secondary'><b>" + writer + " : " + message + "</b></div></div>";
                } else {
                    str = "<div class='col-6'><div class='alert alert-warning'><b>" + writer + " : " + message + "</b></div></div>";
                }

                $("#msgArea").append(str);
            });

            stomp.send('/pub/chat/enter', {}, JSON.stringify({roomId: roomId, writer: username}));
        });

        $("#button-send").on("click", function () {
            var msg = $("#msg").val().trim();
            if (msg !== "") {
                console.log(username + ": " + msg);
                stomp.send('/pub/chat/message', {}, JSON.stringify({roomId: roomId, message: msg, writer: username}));
                $("#msg").val('');
            } else {
                alert("Please enter a message.");
            }
        });
    });
</script>
</body>
</html>
